from datetime import datetime
import csv
import pandas as pd
import os

list_task = []


def task_priority():
    filename = "jadwal.csv"

    # Membaca data jadwal dari file CSV
    with open(filename, 'r') as csvfile:
        reader = csv.DictReader(csvfile)
        rows = list(reader)

    if not rows:
        print("Jadwal kosong.")
        return

    print("Pilihan sorting:")
    print("1. Deadline terdekat")
    print("2. Abjad nama task")
    print("3. Tingkat urgensi")

    pilihan = input("Masukkan pilihan sorting (1/2/3): ")

    if pilihan == '1':
        sorted_rows = sorted(rows, key=lambda row: datetime.strptime(
            row['Deadline'], "%Y-%m-%d").date())
    elif pilihan == '2':
        sorted_rows = sorted(rows, key=lambda row: row['Nama Task'])
    elif pilihan == '3':
        sorted_rows = sorted(
            rows, key=lambda row: float(row['Tingkat Urgensi']))
    else:
        print("Pilihan tidak valid.")
        return

    print("Jadwal yang diurutkan:")

    for row in sorted_rows:
        nama_task = row['Nama Task']
        kategori = row['Kategori']
        urgensi = row['Tingkat Urgensi']
        tanggal_dibuat = datetime.strptime(
            row['Tanggal Dibuat'], "%Y-%m-%d").strftime("%d/%m/%Y")
        deadline = datetime.strptime(
            row['Deadline'], "%Y-%m-%d").strftime("%d/%m/%Y")
        lokasi = row['Lokasi']
        estimasi_deadline = row['Estimasi Deadline']
        rasio = row['Rasio']

        print("Nama Task       : ", nama_task)
        print("Kategori        : ", kategori)
        print("Tingkat Urgensi : ", urgensi)
        print("Tanggal Dibuat  : ", tanggal_dibuat)
        print("Deadline        : ", deadline)
        print("Lokasi          : ", lokasi)
        print("Estimasi Deadline : ", estimasi_deadline)
        print("Rasio           : ", rasio)
        print("-----------------------------")

def tambah_jadwal():
    fields = ['Nama Task', 'Kategori', 'Tingkat Urgensi', 'Tanggal Dibuat',
              'Deadline', 'Lokasi', 'Estimasi Deadline', 'Rasio']
    filename = "jadwal.csv"

    jumlah_task = int(input("Jumlah Task\t\t   : "))
    jadwal_list = []  # Membuat list kosong untuk menyimpan semua task

    file_exists = os.path.isfile(filename)

    for i in range(jumlah_task):
        print("\nTask ke-", i+1)
        nama_task = input("Nama Task\t\t   : ")
        kategori_task = input("Kategori Task\t\t   : ")
        urgensi_task = float(input("Urgensi Task\t\t   : "))

        # Memasukkan format tanggal dibuat
        tanggal_dibuat = input("Tanggal dibuat (DD/MM/YYYY): ")
        tanggal_dibuat = datetime.strptime(tanggal_dibuat, "%d/%m/%Y").date()

        # Memasukkan format deadline task
        deadline_task = input("Deadline Task (DD/MM/YYYY): ")
        deadline_task = datetime.strptime(deadline_task, "%d/%m/%Y").date()

        lokasi = input('Lokasi Task: ')
        # Menghitung estimasi deadline
        estimasi_deadline = (deadline_task - tanggal_dibuat).days

        rasio = urgensi_task / estimasi_deadline

        task_dict = {'Nama Task': nama_task,
                     'Kategori': kategori_task,
                     'Tingkat Urgensi': urgensi_task,
                     'Tanggal Dibuat': tanggal_dibuat,
                     'Deadline': deadline_task,
                     'Lokasi': lokasi,
                     'Estimasi Deadline': estimasi_deadline,
                     'Rasio': rasio}

        jadwal_list.append(task_dict)  # Menambahkan task ke dalam list

    with open(filename, 'a', newline='') as csvfile:
        writer = csv.DictWriter(csvfile, fieldnames=fields)

        if not file_exists:
            writer.writeheader()  # Menulis header jika file baru

        writer.writerows(jadwal_list)

    print("Jadwal berhasil ditambahkan.")


def tampilkan_jadwal():
    filename = "jadwal.csv"

    with open(filename, 'r') as csvfile:
        reader = csv.DictReader(csvfile)
        for row in reader:
            print("Nama Task:", row['Nama Task'])
            print("Kategori:", row['Kategori'])
            print("Tingkat Urgensi:", row['Tingkat Urgensi'])
            print("Tanggal Dibuat:", row['Tanggal Dibuat'])
            print("Deadline:", row['Deadline'])
            print("Lokasi:", row['Lokasi'])
            print("Estimasi Deadline:", row['Estimasi Deadline'])
            print("Rasio:", row['Rasio'])
            print("-" * 30)


def hapus_jadwal(nomor_baris):
    filename = "jadwal.csv"
    rows = []
    with open(filename, 'r') as csvfile:
        reader = csv.DictReader(csvfile)
        rows = list(reader)

    if nomor_baris < 1 or nomor_baris > len(rows):
        print("Nomor baris tidak valid.")
        return
    rows.pop(nomor_baris - 1)

    with open(filename, 'w', newline='') as csvfile:
        writer = csv.DictWriter(csvfile, fieldnames=reader.fieldnames)
        writer.writeheader()
        writer.writerows(rows)

    print("Jadwal berhasil dihapus.")


def edit_jadwal(nomor_baris):
    filename = "jadwal.csv"
    rows = []

    with open(filename, 'r') as csvfile:
        reader = csv.DictReader(csvfile)
        rows = list(reader)

    if nomor_baris < 1 or nomor_baris > len(rows):
        print("Nomor baris tidak valid.")
        return

    row = rows[nomor_baris - 1]

    print("Jadwal sebelum diubah:")
    print("Nomor Baris:", nomor_baris)
    print("Nama Task:", row['Nama Task'])
    print("Kategori:", row['Kategori'])
    print("Tingkat Urgensi:", row['Tingkat Urgensi'])
    print("Tanggal Dibuat:", row['Tanggal Dibuat'])
    print("Deadline:", row['Deadline'])
    print("Lokasi:", row['Lokasi'])
    print("Estimasi Deadline:", row['Estimasi Deadline'])
    print("Rasio:", row['Rasio'])

    konfirmasi = input("Apakah Anda ingin mengubah jadwal ini? (y/n): ")
    if konfirmasi.lower() != 'y':
        print("Pengubahan jadwal dibatalkan.")
        return

    print("\nMasukkan data baru:")
    nama_task = input("Nama Task: ")
    kategori_task = input("Kategori Task: ")
    urgensi_task = float(input("Urgensi Task: "))

    tanggal_dibuat = input("Tanggal dibuat (DD/MM/YYYY): ")
    tanggal_dibuat = datetime.strptime(tanggal_dibuat, "%d/%m/%Y").date()

    deadline_task = input("Deadline Task (DD/MM/YYYY): ")
    deadline_task = datetime.strptime(deadline_task, "%d/%m/%Y").date()

    lokasi = input("Lokasi Task: ")
    estimasi_deadline = (deadline_task - tanggal_dibuat).days
    rasio = urgensi_task / estimasi_deadline

    rows[nomor_baris - 1] = {
        'Nama Task': nama_task,
        'Kategori': kategori_task,
        'Tingkat Urgensi': urgensi_task,
        'Tanggal Dibuat': tanggal_dibuat,
        'Deadline': deadline_task,
        'Lokasi': lokasi,
        'Estimasi Deadline': estimasi_deadline,
        'Rasio': rasio
    }

    with open(filename, 'w', newline='') as csvfile:
        writer = csv.DictWriter(csvfile, fieldnames=reader.fieldnames)
        writer.writeheader()
        writer.writerows(rows)

    konf_berhasil = input("Jadwal berhasil diubah. klik enter untuk kembali")
    if konf_berhasil.isprintable():
        os.system("cls")
        main()


def main():
    print("=== Aplikasi Jadwal ===")
    tampilkan_jadwal()
    while True:
        print("\nMenu:")
        print("1. Tampilkan Jadwal")
        print("2. Tambah Jadwal")
        print("3. Hapus Jadwal")
        print("4. Edit Jadwal")
        print("5. Urutkan Berdasarkan Prioritas")
        print("6. Keluar")

        pilihan = input("Masukkan pilihan (1/2/3/4/5/6): ")

        if pilihan == "1":
            tampilkan_jadwal()

        elif pilihan == "2":
            tambah_jadwal()
            a = input("Klik 'enter' untuk kembali ke menu aplkasi ")
            if a.isprintable():
                os.system("cls")
                main()

        elif pilihan == "3":
            tampilkan_jadwal()
            nomor_baris = int(
                input("Masukkan nomor baris yang akan dihapus: "))
            hapus_jadwal(nomor_baris)
            while True:
                a = input(
                    "Jadwal berhasil dihapus, klik enter untuk kembali ke menu aplikasi")
                if a.isprintable():
                    os.system("cls")
                    main()

        elif pilihan == "4":
            tampilkan_jadwal()
            nomor_baris = int(input("Masukkan nomor baris yang akan diubah: "))
            edit_jadwal(nomor_baris)

        elif pilihan == "5":
            task_priority()

        elif pilihan == "6":
            os.system("cls")
            break

        else:
            print("Pilihan tidak valid. Silakan coba lagi.")


if __name__ == '__main__':
    main()

# NOTE BUAT FILE CSV DULU (jadwal.csv) baru bisa di run
